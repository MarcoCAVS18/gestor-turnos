// src/pages/Turnos.jsx - MEJORADO con layout de 3 columnas y agrupaci√≥n por semanas

import React, { useState, useMemo } from 'react';
import { useApp } from '../contexts/AppContext';
import { useTurnManager } from '../hooks/useTurnManager';
import { useDeleteManager } from '../hooks/useDeleteManager';
import { useFilterTurnos } from '../hooks/useFilterTurnos';
import LoadingWrapper from '../components/layout/LoadingWrapper';
import ShiftsHeader from '../components/shifts/ShiftsHeader';
import ShiftsEmptyState from '../components/shifts/ShiftsEmptyState';
import FiltrosTurnos from '../components/filters/FiltrosTurnos';
import ModalTurno from '../components/modals/ModalTurno';
import AlertaEliminacion from '../components/alerts/AlertaEliminacion';
import WeeklyShiftsSection from '../components/shifts/WeeklyShiftsSection';
import { generateShiftDetails } from '../utils/shiftDetailsUtils';

const WEEKS_PER_PAGE = 4; // Mostrar 4 semanas por p√°gina

const Turnos = () => {
  const { 
    loading, 
    deleteShift, 
    deleteDeliveryShift, 
    thematicColors, 
    turnosPorFecha,
    trabajos,
    trabajosDelivery 
  } = useApp();
  
  const [weeksShown, setWeeksShown] = useState(WEEKS_PER_PAGE);
  const [expanding, setExpanding] = useState(false);

  // Hook para gesti√≥n de filtros
  const {
    filters,
    actualizarFiltros,
    turnosFiltrados,
    estadisticasFiltros,
    tieneMetrosDeFiltrosActivos
  } = useFilterTurnos(turnosPorFecha);

  // Hooks especializados
  const { modalAbierto, turnoSeleccionado, abrirModalNuevo, abrirModalEditar, cerrarModal } = useTurnManager();
  
  // Funci√≥n de eliminaci√≥n
  const handleDeleteTurno = async (turno) => {
    try {
      if (turno.tipo === 'delivery') {
        await deleteDeliveryShift(turno.id);
      } else {
        await deleteShift(turno.id);
      }
    } catch (error) {
      console.error('Error eliminando turno:', error);
    }
  };

  const deleteManager = useDeleteManager(handleDeleteTurno);

  // Procesar datos de turnos (usar filtrados si hay filtros activos)
  const turnosParaMostrar = tieneMetrosDeFiltrosActivos ? turnosFiltrados : turnosPorFecha;
  const allJobs = useMemo(() => [...trabajos, ...trabajosDelivery], [trabajos, trabajosDelivery]);

  // Funci√≥n para obtener el lunes de una fecha
  const obtenerLunesDeLaSemana = (fecha) => {
    const date = new Date(fecha + 'T00:00:00');
    const diaSemana = date.getDay();
    const diasHastaLunes = diaSemana === 0 ? -6 : -(diaSemana - 1);
    const lunes = new Date(date);
    lunes.setDate(date.getDate() + diasHastaLunes);
    return lunes.toISOString().split('T')[0];
  };

  // Funci√≥n para formatear el rango de semana
  const formatearRangoSemana = (fechaLunes) => {
    const lunes = new Date(fechaLunes + 'T00:00:00');
    const domingo = new Date(lunes);
    domingo.setDate(lunes.getDate() + 6);

    const opcionesLunes = { day: 'numeric', month: 'short' };
    const opcionesDomingo = { day: 'numeric', month: 'short', year: 'numeric' };

    const lunesStr = lunes.toLocaleDateString('es-ES', opcionesLunes);
    const domingoStr = domingo.toLocaleDateString('es-ES', opcionesDomingo);

    return `${lunesStr} - ${domingoStr}`;
  };

  // Agrupar turnos por semanas
  const turnosPorSemana = useMemo(() => {
    const semanas = {};
    
    Object.entries(turnosParaMostrar || {}).forEach(([fecha, turnos]) => {
      const fechaLunes = obtenerLunesDeLaSemana(fecha);
      
      if (!semanas[fechaLunes]) {
        semanas[fechaLunes] = {};
      }
      
      semanas[fechaLunes][fecha] = turnos;
    });

    // Ordenar semanas por fecha (m√°s reciente primero)
    const semanasOrdenadas = Object.keys(semanas)
      .sort((a, b) => new Date(b) - new Date(a))
      .map(fechaLunes => ({
        fechaLunes,
        rangoSemana: formatearRangoSemana(fechaLunes),
        turnos: semanas[fechaLunes],
        totalTurnos: Object.values(semanas[fechaLunes]).flat().length
      }));

    return semanasOrdenadas;
  }, [turnosParaMostrar]);

  const semanasParaMostrar = turnosPorSemana.slice(0, weeksShown);
  const hayMasSemanas = turnosPorSemana.length > weeksShown;
  const semanasRestantes = turnosPorSemana.length - weeksShown;
  const hayTurnos = turnosPorSemana.length > 0;

  const handleShowMoreWeeks = () => {
    setExpanding(true);
    setTimeout(() => {
      setWeeksShown(prev => Math.min(prev + WEEKS_PER_PAGE, turnosPorSemana.length));
      setExpanding(false);
    }, 150);
  };

  const handleShowLessWeeks = () => {
    setWeeksShown(WEEKS_PER_PAGE);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const testDelete = (turno) => {
    deleteManager.startDeletion(turno);
  };

  return (
    <LoadingWrapper loading={loading}>
      {/* Contenedor principal con espaciado mejorado */}
      <div className="px-4 py-6 pb-32 space-y-6">
        {/* Header con t√≠tulo y bot√≥n de acci√≥n */}
        <ShiftsHeader 
          hasShifts={hayTurnos}
          allJobs={allJobs}
          sortedDays={turnosPorSemana}
          daysShown={weeksShown}
          onNewShift={abrirModalNuevo}
          thematicColors={thematicColors}
          daysPerPage={WEEKS_PER_PAGE}
        />

        {/* Sistema de filtros */}
        {(Object.keys(turnosPorFecha || {}).length > 0) && (
          <FiltrosTurnos
            onFiltersChange={actualizarFiltros}
            activeFilters={filters}
          />
        )}

        {/* Estad√≠sticas de filtrado */}
        {tieneMetrosDeFiltrosActivos && (
          <div 
            className="p-3 rounded-lg border-l-4 text-sm"
            style={{ 
              backgroundColor: thematicColors?.transparent5,
              borderLeftColor: thematicColors?.base 
            }}
          >
            <div className="flex items-center justify-between">
              <span style={{ color: thematicColors?.base }} className="font-medium">
                Mostrando {estadisticasFiltros.turnosFiltrados} de {estadisticasFiltros.totalTurnos} turnos
              </span>
              <span className="text-gray-600">
                {turnosPorSemana.length} semanas con turnos
              </span>
            </div>
          </div>
        )}

        {/* Contenido principal */}
        {!hayTurnos && !tieneMetrosDeFiltrosActivos ? (
          <ShiftsEmptyState 
            allJobs={allJobs}
            onNewShift={abrirModalNuevo}
            thematicColors={thematicColors}
          />
        ) : !hayTurnos && tieneMetrosDeFiltrosActivos ? (
          // Estado cuando hay filtros pero no resultados
          <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
            <div 
              className="p-4 rounded-full w-20 h-20 mx-auto mb-4 flex items-center justify-center"
              style={{ backgroundColor: thematicColors?.transparent10 }}
            >
              <span className="text-2xl">üîç</span>
            </div>
            <h3 className="text-lg font-semibold text-gray-900 mb-2">
              No hay turnos que coincidan con los filtros
            </h3>
            <p className="text-gray-500 mb-6 max-w-md mx-auto">
              Intenta ajustar los filtros para ver m√°s resultados.
            </p>
            <button
              onClick={() => actualizarFiltros({ trabajo: 'todos', diasSemana: [], tipoTurno: 'todos' })}
              className="text-white px-6 py-3 rounded-lg transition-colors hover:opacity-90"
              style={{ backgroundColor: thematicColors?.base }}
            >
              Limpiar filtros
            </button>
          </div>
        ) : (
          <>
            {/* Lista de turnos organizados por semanas */}
            <div className="space-y-8">
              {semanasParaMostrar.map(({ fechaLunes, rangoSemana, turnos, totalTurnos }) => (
                <WeeklyShiftsSection
                  key={fechaLunes}
                  rangoSemana={rangoSemana}
                  turnos={turnos}
                  totalTurnos={totalTurnos}
                  allJobs={allJobs}
                  onEditShift={abrirModalEditar}
                  onDeleteShift={testDelete}
                  thematicColors={thematicColors}
                />
              ))}
            </div>

            {/* Navegaci√≥n (mostrar m√°s/menos semanas) */}
            {hayMasSemanas && (
              <div className="relative flex flex-col items-center pt-8 pb-12">
                <div
                  className="absolute top-0 left-0 right-0 h-16 rounded-lg opacity-30"
                  style={{ backgroundColor: thematicColors?.transparent5 }}
                />
                <button
                  onClick={handleShowMoreWeeks}
                  disabled={expanding}
                  className="relative z-10 flex items-center space-x-2 px-6 py-3 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-all disabled:opacity-50"
                  style={{ 
                    borderColor: thematicColors?.transparent20,
                    color: thematicColors?.base
                  }}
                >
                  {expanding ? (
                    <>
                      <div 
                        className="animate-spin rounded-full h-4 w-4 border-b-2"
                        style={{ borderColor: thematicColors?.base }}
                      />
                      <span>Cargando...</span>
                    </>
                  ) : (
                    <>
                      <span>üëÅÔ∏è</span>
                      <span>Ver {Math.min(WEEKS_PER_PAGE, semanasRestantes)} semanas m√°s</span>
                    </>
                  )}
                </button>
              </div>
            )}

            {!hayMasSemanas && weeksShown > WEEKS_PER_PAGE && (
              <div className="flex justify-center py-4">
                <button
                  onClick={handleShowLessWeeks}
                  className="flex items-center space-x-2 px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors"
                >
                  <span>‚Üë</span>
                  <span>Mostrar menos</span>
                </button>
              </div>
            )}
          </>
        )}
      </div>

      {/* Modales */}
      <ModalTurno 
        isOpen={modalAbierto} 
        onClose={cerrarModal} 
        turno={turnoSeleccionado} 
      />

      <AlertaEliminacion
        visible={deleteManager.showDeleteModal}
        onCancel={() => {
          deleteManager.cancelDeletion();
        }}
        onConfirm={() => {
          deleteManager.confirmDeletion();
        }}
        eliminando={deleteManager.deleting}
        tipo="turno"
        detalles={generateShiftDetails(deleteManager.itemToDelete, allJobs)}
      />
    </LoadingWrapper>
  );
};

export default Turnos;